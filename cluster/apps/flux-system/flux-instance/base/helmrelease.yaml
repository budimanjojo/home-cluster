---
# yaml-language-server: $schema=https://schemas.budimanjojo.com/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: flux-instance
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: flux-instance
  values:
    instance:
      distribution:
        artifact: oci://ghcr.io/controlplaneio-fluxcd/flux-operator-manifest:v0.38.1
        version: 2.x

      cluster:
        networkPolicy: false

      components:
        - source-controller
        - kustomize-controller
        - helm-controller
        - notification-controller

      sync:
        kind: GitRepository
        url: https://github.com/budimanjojo/home-cluster
        ref: refs/heads/main
        path: cluster/base
        interval: 1h

      kustomize:
        patches:
          # increase the number of workers
          - target:
              kind: Deployment
              name: (kustomize-controller|helm-controller|source-controller)
            patch: |-
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --concurrent=10
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --requeue-dependency=5s

          # increase the memory limits
          - target:
              kind: Deployment
              name: (kustomize-controller|helm-controller|source-controller)
            patch: |-
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: all
              spec:
                template:
                  spec:
                    containers:
                      - name: manager
                        resources:
                          limits:
                            memory: 2Gi

          # enable in-memory kustomize builds
          - target:
              kind: Deployment
              name: kustomize-controller
            patch: |-
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --concurrent=20
              - op: add
                path: /spec/template/spec/volumes/0
                value:
                  name: temp
                  emptyDir:
                    medium: Memory

          # enable Helm repositories caching
          - target:
              kind: Deployment
              name: source-controller
            patch: |-
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --helm-cache-max-size=10
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --helm-cache-ttl=60m
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --helm-cache-purge-interval=5m

          # cache Secrets and ConfigMaps
          - target:
              kind: Deployment
              name: source-controller
            patch: |-
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --feature-gates=CacheSecretsAndConfigMaps=true

          # Flux near OOM detection for Helm
          - target:
              kind: Deployment
              name: helm-controller
            patch: |-
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --feature-gates=OOMWatch=true
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --oom-watch-memory-threshold=95
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --oom-watch-interval=500ms

          # disable chart digest tracking
          - target:
              kind: Deployment
              name: helm-controller
            patch: |-
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --feature-gates=DisableChartDigestTracking=true

          # controller-level SOPS decryption
          - target:
              kind: Deployment
              name: kustomize-controller
            patch: |-
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --sops-age-secret=sops-age

          # watch Secrets and ConfigMaps attachec to HelmReleases and Kustomizations
          - target:
              kind: Deployment
              name: (helm-controller|kustomize-controller)
            patch: |-
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: --watch-configs-label-selector=owner!=helm

          # cancel health checks on new Kustomization revisions
          - target:
              kind: Deployment
              name: kustomize-controller
            patch: |-
              - op: add
                path: /spec/template/spec/containers/0/args/-
                value: feature-gates=CancelHealthCheckOnNewRevision=true
