apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: &app transmission
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 1.2.1
      sourceRef:
        kind: HelmRepository
        name: bjw-s-charts
        namespace: flux-system
      interval: 15m
  install:
    createNamespace: true
    remediation:
      retries: 5
  upgrade:
    remediation:
      retries: 5
  values:
    global:
      nameOverride: *app
    image:
      repository: ghcr.io/k8s-at-home/transmission
      tag: v3.00
    service:
      main:
        ports:
          http:
            port: 9091
          tcp:
            enabled: true
            primary: true
            protocol: TCP
            port: 51413
          udp:
            enabled: true
            protocol: UDP
            port: 51413
    configMaps:
      config:
        enabled: true
        data:
          settings.json: |
            {
              "alt-speed-down": 50,
              "alt-speed-enabled": false,
              "alt-speed-time-begin": 540,
              "alt-speed-time-day": 127,
              "alt-speed-time-enabled": false,
              "alt-speed-time-end": 1020,
              "alt-speed-up": 50,
              "bind-address-ipv4": "0.0.0.0",
              "bind-address-ipv6": "::",
              "blocklist-enabled": false,
              "blocklist-url": "http://www.example.com/blocklist",
              "cache-size-mb": 4,
              "dht-enabled": true,
              "download-dir": "/downloads/Completed",
              "download-queue-enabled": true,
              "download-queue-size": 10,
              "encryption": 1,
              "idle-seeding-limit": 30,
              "idle-seeding-limit-enabled": true,
              "incomplete-dir": "/downloads/Incomplete",
              "incomplete-dir-enabled": true,
              "lpd-enabled": false,
              "message-level": 2,
              "peer-congestion-algorithm": "",
              "peer-id-ttl-hours": 6,
              "peer-limit-global": 200,
              "peer-limit-per-torrent": 50,
              "peer-port": 51413,
              "peer-port-random-high": 65535,
              "peer-port-random-low": 49152,
              "peer-port-random-on-start": false,
              "peer-socket-tos": "default",
              "pex-enabled": true,
              "port-forwarding-enabled": false,
              "preallocation": 1,
              "prefetch-enabled": 1,
              "queue-stalled-enabled": true,
              "queue-stalled-minutes": 30,
              "ratio-limit": 0.40,
              "ratio-limit-enabled": true,
              "rename-partial-files": true,
              "rpc-authentication-required": true,
              "rpc-bind-address": "0.0.0.0",
              "rpc-enabled": true,
              "rpc-password": "22qv&xyw7V2K^i",
              "rpc-port": 9091,
              "rpc-url": "/transmission/",
              "rpc-username": "budiman",
              "rpc-whitelist": "127.0.0.1",
              "rpc-whitelist-enabled": false,
              "scrape-paused-torrents-enabled": true,
              "script-torrent-done-enabled": false,
              "script-torrent-done-filename": "",
              "seed-queue-enabled": true,
              "seed-queue-size": 1,
              "speed-limit-down": 100,
              "speed-limit-down-enabled": false,
              "speed-limit-up": 100,
              "speed-limit-up-enabled": false,
              "start-added-torrents": true,
              "trash-original-torrent-files": false,
              "umask": 2,
              "upload-slots-per-torrent": 14,
              "utp-enabled": true
            }
    initContainers:
      init-permission:
        image: busybox:1.35.0
        imagePullPolicy: IfNotPresent
        command:
          - sh
          - -c
        args:
          - chown -R 568:568 /downloads
        securityContext:
          runAsUser: 0
        volumeMounts:
          - name: downloads
            mountPath: /downloads
    podSecurityContext:
      runAsUser: 568
      runAsGroup: 568
      fsGroup: 568
      fsGroupChangePolicy: OnRootMismatch
    persistence:
      config:
        enabled: true
        type: configMap
        name: transmission-config
        mountPath: /config/settings.json
        subPath: settings.json
      data:
        enabled: true
        existingClaim: transmission-config
        mountPath: /config
      downloads:
        enabled: true
        existingClaim: shared-downloads
        mountPath: /downloads
      resources:
        requests:
          cpu: 15m
          memory: 105Mi
        limits:
          memory: 105Mi
